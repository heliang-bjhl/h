seajs.use("calendar_css"),seajs.use(["$","textLimit","select","util","calendar","validator","uploadify","autocomplete","confirmbox"],function(a,b,c,d,e,f){var g={};f.addRule("phoneArrs",function(a){var b=a.element.val();if(!b)return!1;for(var c=b.split(","),d=/\D/g,e=0;e<c.length;e++)if(d.test(c[e]))return!1;return!0},"请按照规则输入");var h=new f({element:"#frmSearch",onFormValidated:function(a){1!=a&&i.sb()},autoSubmit:!1,failSilently:!0}),i={setCal:function(){g.nowDate=d.getCurrentDate();var a=new e({trigger:"#birthday_Start_Date",range:[null,g.nowDate]}),b=new e({trigger:"#birthday_End_Date",range:[null,g.nowDate]});a.on("selectDate",function(a){b.range([a,g.nowDate])}),b.on("selectDate",function(b){a.range([null,b])});var c=new e({trigger:"#regist_Start_Date",range:[null,g.nowDate]}),f=new e({trigger:"#regist_End_Date",range:[null,g.nowDate]});c.on("selectDate",function(a){f.range([a,g.nowDate])}),f.on("selectDate",function(a){c.range([null,a])});new e({trigger:"#send_Time",range:[d.getCurrentDate(),d.getDateRangeTime(d.getCurrentDate(),30)]})},disSel:function(){for(var a=0;8>a;a++)g.send_Time_Hour.disableOption(a);for(var b=18;24>b;b++)g.send_Time_Hour.disableOption(b)},setSel:function(){g.z_gender=new c({trigger:"#z_gender"}).render(),g.z_sms_style=new c({trigger:"#z_sms_style"}).render(),g.send_Time_Hour=new c({trigger:"#send_Time_Hour"}).render(),g.send_Time_Minute=new c({trigger:"#send_Time_Minute"}).render()},setVal:function(){var b=200-a("#endtitleofsms").val().length;h.addItem({element:"#z_sms_detail",required:!0,rule:"minlength{min:1} maxlength{max:"+b+"}",display:"短信",errormessageRequired:"短信内容为必填字段。"}).addItem({element:"#z_sms_sel_hide_area",required:!0,errormessageRequired:"短信类型为必选。"}).addItem({element:"#send_Time",required:!0,errormessageRequired:"发送时间为必填字段。"}).addItem({element:'input[name="sendType"]',required:!0,errormessageRequired:"正告：请在8:00-18:00期间发送短信！"})},setTextarea:function(){var c=a("#endtitleofsms").val().length;b({input:"#z_sms_detail",tip:"#lblDescriptionMsg",msg:function(b){var d=0;return b.count<=70-c?(d=1,g.num=d,a("#upnums").val(b.count+c),a("#uplistnums").val(d),"字数为{count},短信分为"+d+"条。"):b.count<=200-c&&b.count>70-c?(d=Math.ceil((b.count+c)/67),g.num=d,a("#upnums").val(b.count+c),a("#uplistnums").val(d),"字数为{count},短信分为"+d+"条。"):"不能超过{max}个字"},max:200-c,min:0,enableBr:!0,changeFn:function(){}}).init()},search:function(){},getHtml:function(a){var b=['<div class="dialog-form">',"<p>您将要发送"+a+"×"+g.num+"条短信</p>","<p>是否确认发送？</p>","</form>","</div>"].join("");return b},getSendObjs:function(){var b={};if("2"==a('input[name="sendType"]:checked').val()){var c=d.timeToString({date:"#send_Time",hour:"#send_Time_Hour",minute:"#send_Time_Minute",type:"date"})+":00";b.sendTime=c}else b.sendTime="";if("1"==a('input[name="sendmethods"]:checked').val()){var e,f;e=a("#regist_Start_Date").val()?a("#regist_Start_Date").val()+" 00:00:00":"",f=a("#regist_End_Date").val()?a("#regist_End_Date").val()+" 23:59:59":"",b.startTime=e,b.endTime=f}return b.sendContent=a("#z_sms_detail").val()+a("#endtitleofsms").val(),b},sb:function(){extraData=i.getSendObjs(),d.formSend("#frmSearch",{extraData:extraData,success:function(b){if(!g.searchReady){var c=b.data.count,e=b.data.submitTime;a("#submitTime").val(e),Util.confirm.open({title:"确认操作",message:i.getHtml(c),confirmTpl:'<span class="ui-button ui-button-morange" id="j_bt_yes">确定</span>',cancelTpl:'<span class="ui-button ui-button-morange" id="j_bt_no">取消</span>',width:300,onConfirm:function(){a("#frmSearch").attr("action","/t/sms/send"),i.sb2(),g.searchReady=!0},onCancel:function(){a("#frmSearch").attr("action","/t/sms/count"),g.searchReady=!1,d.confirm.close()},onClose:function(){a("#frmSearch").attr("action","/t/sms/count"),g.searchReady=!1}})}},error:function(){d.alert("操作超时")}})},sb2:function(){var a=i.getSendObjs();d.formSend("#frmSearch",{extraData:a,submitButton:"#j_bt_yes",ajaxSuccess:function(a){d.go(a)},error:function(){d.alert("操作超时")}})},bind:function(){g.z_sms_style.on("change",function(b){a("#z_sms_sel_hide_area").val(b.attr("data-value"))}),a("#z_all_checkbox").on("change",function(){this.checked?a(".z_style_box").prop("checked","checked"):a(".z_style_box").prop("checked","")}),a(".z_style_box").on("click",function(){var b=0;this.checked?(a(".z_style_box").each(function(){this.checked&&(b+=1)}),b==a(".z_style_box").length&&a("#z_all_checkbox").prop("checked",!0)):a("#z_all_checkbox").prop("checked",!1)}),a('input[name="sendmethods"]').change(function(){h.removeItem(".z_style_box").removeItem("#hand_copy_tels"),"1"==a(this).val()?(a("#mes_for_merchant").hide(),a("#mes_for_hand").hide(),a("#mes_for_member").show()):"2"==a(this).val()?(h.addItem({element:".z_style_box",required:!0,errormessageRequired:"商户业态为必选。"}),a("#mes_for_member").hide(),a("#mes_for_hand").hide(),a("#mes_for_merchant").show()):"3"==a(this).val()&&(h.addItem({element:"#hand_copy_tels",required:!0,rule:"phoneArrs",errormessageRequired:"号码为必填。"}),a("#mes_for_member").hide(),a("#mes_for_merchant").hide(),a("#mes_for_hand").show())}),a('input[name="sendType"]').change(function(){h.removeItem("#send_Time"),"2"==a(this).val()?(h.addItem({element:"#send_Time",required:!0,errormessageRequired:"发送时间为必填字段。"}),a("#z_Send_Style").show()):"1"==a(this).val()&&a("#z_Send_Style").hide()})}},j=function(){i.setCal(),i.setSel(),i.setVal(),i.setTextarea(),i.disSel(),i.bind()};j(),$$m.finish("ok")});